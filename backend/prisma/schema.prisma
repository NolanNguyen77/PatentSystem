generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  name         String
  password     String // Hashed with bcrypt
  email        String?
  departmentId String?  @map("department_id")
  section      String?
  permission   String   @default("一般") // 管理者/一般/閲覧
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  department        Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  titleUsers        TitleUser[]
  mainOwnedTitles   Title[]            @relation("TitleMainOwner")
  evaluations       Evaluation[]
  activityLogs      ActivityLog[]
  patentAssignments PatentAssignment[]

  @@map("users")
}

// Departments table
model Department {
  id           String   @id @default(uuid())
  no           String   @unique
  name         String
  abbreviation String?
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("departments")
}

// Titles table (保存タイトル)
model Title {
  id                              String   @id @default(uuid())
  titleNo                         String   @unique @map("title_no")
  titleName                       String   @map("title_name")
  dataType                        String   @default("特許") @map("data_type")
  markColor                       String?  @map("mark_color")
  parentTitleId                   String?  @map("parent_title_id")
  mainOwnerId                     String?  @map("main_owner_id")
  saveDate                        String   @map("save_date")
  disallowEvaluation              Boolean  @default(false) @map("disallow_evaluation")
  allowEvaluation                 Boolean  @default(true) @map("allow_evaluation")
  viewPermission                  String   @default("all") @map("view_permission")
  editPermission                  String   @default("creator") @map("edit_permission")
  mainEvaluation                  Boolean  @default(true) @map("main_evaluation")
  singlePatentMultipleEvaluations Boolean  @default(false) @map("single_patent_multiple_evals")
  createdBy                       String   @map("created_by")
  createdAt                       DateTime @default(now()) @map("created_at")
  updatedAt                       DateTime @updatedAt @map("updated_at")

  parentTitle     Title?                 @relation("TitleHierarchy", fields: [parentTitleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childTitles     Title[]                @relation("TitleHierarchy")
  mainOwner       User?                  @relation("TitleMainOwner", fields: [mainOwnerId], references: [id], onDelete: SetNull)
  titleUsers      TitleUser[]
  patents         Patent[]
  evaluations     Evaluation[]
  attachments     Attachment[]
  classifications PatentClassification[]
  activityLogs    ActivityLog[]

  @@map("titles")
}

// Title-User relationship (担当者)
model TitleUser {
  id                String   @id @default(uuid())
  titleId           String   @map("title_id")
  userId            String   @map("user_id")
  isMainResponsible Boolean  @default(false) @map("is_main_responsible")
  isAdmin           Boolean  @default(false) @map("is_admin")
  isGeneral         Boolean  @default(true) @map("is_general")
  isViewer          Boolean  @default(false) @map("is_viewer")
  evalEmail         Boolean  @default(false) @map("eval_email")
  confirmEmail      Boolean  @default(false) @map("confirm_email")
  displayOrder      Int      @default(0) @map("display_order")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  title Title @relation(fields: [titleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([titleId, userId])
  @@map("title_users")
}

// Patents table
model Patent {
  id               String    @id @default(uuid())
  titleId          String    @map("title_id")
  documentNum      String?   @map("document_num")
  applicationNum   String?   @map("application_num")
  applicationDate  DateTime? @map("application_date")
  publicationDate  DateTime? @map("publication_date")
  inventionTitle   String?   @map("invention_title")
  applicantName    String?   @map("applicant_name")
  fiClassification String?   @map("fi_classification")
  publicationNum   String?   @map("publication_num")
  announcementNum  String?   @map("announcement_num")
  registrationNum  String?   @map("registration_num")
  appealNum        String?   @map("appeal_num")
  abstract         String?   @map("abstract")
  claims           String?   @map("claims")
  otherInfo        String?   @map("other_info")
  statusStage      String?   @map("status_stage")
  eventDetail      String?   @map("event_detail")
  documentUrl      String?   @map("document_url")
  evaluationStatus String    @default("未評価") @map("evaluation_status")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  title           Title                  @relation(fields: [titleId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  evaluations     Evaluation[]
  classifications PatentClassification[]
  assignments     PatentAssignment[]

  @@index([titleId])
  @@index([applicantName])
  @@index([applicationDate])
  @@index([publicationDate])
  @@map("patents")
}

// Evaluations table
model Evaluation {
  id        String   @id @default(uuid())
  patentId  String   @map("patent_id")
  titleId   String   @map("title_id")
  userId    String   @map("user_id")
  status    String
  comment   String?
  score     Int?
  isPublic  Boolean  @default(false) @map("is_public")
  isDeleted Boolean  @default(false) @map("is_deleted")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  patent Patent @relation(fields: [patentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  title  Title  @relation(fields: [titleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user   User   @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: Cascade)

  @@index([patentId])
  @@index([titleId])
  @@index([userId])
  @@map("evaluations")
}

// Patent Classifications
model PatentClassification {
  id                  String   @id @default(uuid())
  patentId            String   @map("patent_id")
  titleId             String   @map("title_id")
  classificationType  String   @map("classification_type")
  classificationValue String   @map("classification_value")
  createdAt           DateTime @default(now()) @map("created_at")

  patent Patent @relation(fields: [patentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  title  Title  @relation(fields: [titleId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([patentId, titleId, classificationType, classificationValue])
  @@index([titleId, classificationType, classificationValue])
  @@map("patent_classifications")
}

// Attachments table
model Attachment {
  id           String   @id @default(uuid())
  titleId      String   @map("title_id")
  filename     String
  originalName String   @map("original_name")
  size         BigInt
  mimeType     String   @map("mime_type")
  filePath     String   @map("file_path")
  uploadedBy   String   @map("uploaded_by")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  title Title @relation(fields: [titleId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([titleId])
  @@map("attachments")
}

// Activity Logs
model ActivityLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  titleId    String?  @map("title_id")
  action     String
  targetType String   @map("target_type")
  targetId   String?  @map("target_id")
  details    String?
  ipAddress  String?  @map("ip_address")
  createdAt  DateTime @default(now()) @map("created_at")

  user  User?  @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  title Title? @relation(fields: [titleId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([userId])
  @@index([titleId])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("activity_logs")
}

// Patent-User Assignments (担当者分担)
model PatentAssignment {
  id        String   @id @default(uuid())
  patentId  String   @map("patent_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  patent Patent @relation(fields: [patentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([patentId, userId])
  @@index([patentId])
  @@index([userId])
  @@map("patent_assignments")
}
